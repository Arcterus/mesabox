pipeline:
  build:
    image: ${RUST_VERSION}
    secrets: [ coveralls_token ]
    environment:
      - RUST_COV_VERSION="rustlang/rust:nightly"
    commands:
      - rustup show
      - cargo build
      - cargo test
      - |
        if [ "${RUST_VERSION}" = "${RUST_COV_VERSION}" ]; then
          apt-get update
          apt-get install -y --no-install-recommends lcov llvm ruby
          gem install coveralls-lcov
          ./util/run-cov.sh
          coveralls-lcov -t ${COVERALLS_TOKEN} final.info
        fi

matrix:
  RUST_VERSION:
    - rust:1.26
    - rust:latest
    - rustlang/rust:nightly
